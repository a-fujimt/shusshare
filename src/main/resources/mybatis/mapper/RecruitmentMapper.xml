<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.akichil.shusshare.repository.mybatis.RecruitmentMapper">

    <resultMap id="RecruitmentDetail" type="net.akichil.shusshare.entity.RecruitmentDetail">
        <result property="recruitmentId" column="r_recruitment_id"/>
        <result property="createdBy" column="r_created_by"/>
        <result property="shusshaId" column="r_shussha_id"/>
        <result property="title" column="r_title"/>
        <result property="genre" column="r_genre"/>
        <result property="deadline" column="r_deadline"/>
        <result property="capacity" column="r_capacity"/>
        <result property="participantCount" column="r_participant_count"/>
        <result property="status" column="r_status"/>
        <result property="lockVersion" column="r_lock_version"/>
        <result property="canParticipate" column="r_can_participate"/>
        <association property="createdFriend" resultMap="net.akichil.shusshare.repository.mybatis.FriendMapper.FriendDetail"/>
        <collection property="participants" resultMap="net.akichil.shusshare.repository.mybatis.AccountMapper.Account"/>
    </resultMap>

    <select id="findList" resultMap="RecruitmentDetail">
        SELECT
            <include refid="columns"/>
        FROM
            <include refid="joinRecruitmentAccountRecruitmentParticipant"/>
        WHERE
            f.status = '${@net.akichil.shusshare.entity.FriendStatus@FOLLOWED.getValue}'
    </select>

    <select id="findOne" resultMap="RecruitmentDetail">
        SELECT
            <include refid="columns"/>
        FROM
            <include refid="joinRecruitmentAccountRecruitmentParticipant"/>
        WHERE
            r.recruitment_id = #{recruitmentId}
    </select>

    <sql id="columns">
        r.recruitment_id AS r_recruitment_id,
        r.created_by AS r_created_by,
        f.account_id_from AS f_account_id_from,
        f.account_id_to AS f_account_id_to,
        a.account_id AS f_account_id,
        a.user_id AS f_user_id,
        a.user_name AS f_user_name,
        a.profile AS f_profile,
        a.profile_photo_url AS f_profile_photo_url,
        a.shussha_count AS f_shussha_count,
        a.status AS f_account_status,
        f.status AS f_status,
        f.lock_version AS f_lock_version,
        f.updated_at AS f_updated_at,
        r.shussha_id AS r_shussha_id,
        r.title AS r_title,
        r.genre AS r_genre,
        r.capacity AS r_capacity,
        r.deadline AS r_deadline,
        r.participant_count AS r_participant_count,
        r.status AS r_status,
        r.lock_version AS r_lock_version,
        rp_a.account_id AS a_account_id,
        rp_a.user_id AS a_user_id,
        rp_a.user_name AS a_user_name,
        rp_a.profile AS a_profile,
        rp_a.profile_photo_url AS a_profile_photo_url,
        rp_a.shussha_count AS a_shussha_count,
        rp_a.status AS a_status,
        rp_a.updated_at AS a_updated_at
    </sql>

    <sql id="joinRecruitmentAccountRecruitmentParticipant">
        recruitment r
        INNER JOIN account a
        ON r.created_by = a.account_id
        LEFT OUTER JOIN
            (SELECT
                rp.recruitment_id,
                a.account_id,
                a.user_id,
                a.user_name,
                a.profile,
                a.profile_photo_url,
                a.shussha_count,
                a.status,
                a.updated_at
            FROM
                recruitment_participant rp
                JOIN account a
                ON rp.account_id = a.account_id
            ) AS rp_a
        ON r.recruitment_id = rp_a.recruitment_id
        LEFT OUTER JOIN
            (SELECT
                account_id_from,
                account_id_to,
                status,
                lock_version,
                updated_at
            FROM
                friend
            WHERE
                account_id_from = #{accountId}
            ) AS f
        ON r.created_by = f.account_id_to
    </sql>


</mapper>
